# Phase 15 — Notes & Known Limitations

## Phase 15.2 — Hardening generate-response (✅ COMPLETED)

### Objectif
Éliminer le bug `Cannot read properties of null (reading 'body_text')` et garantir que toute entrée invalide retourne `VALIDATION_FAILED`, jamais `UNKNOWN`.

### Corrections appliquées

| Guard | Emplacement | Description |
|-------|-------------|-------------|
| Guard 1 | Ligne ~1271 | Rejette `{}` → `VALIDATION_FAILED` |
| Guard 1b | Ligne ~1306 | Email non trouvé → `VALIDATION_FAILED` (via service role) |
| Guard 2 | Ligne ~1651 | `body_text` null/invalide → `VALIDATION_FAILED` |

### Tests de validation Phase 15.2

| Test | Body | HTTP | Error Code | Résultat |
|------|------|------|------------|----------|
| VALIDATION (vide) | `{}` | 400 | VALIDATION_FAILED | ✅ PASS |
| VALIDATION (emailId invalide) | `{ "emailId": "uuid-inexistant" }` | 400 | VALIDATION_FAILED | ✅ PASS |
| EXECUTION (nominal) | `{ "quotationData": {...} }` | 200 | ok: true | ✅ PASS |

### Critères de clôture

| Critère | État |
|---------|------|
| Plus de `UNKNOWN` sur generate-response | ✅ |
| Inputs invalides → `VALIDATION_FAILED` | ✅ |
| Runtime contract intact | ✅ |
| Phase 15.1 rerunnable sans warning | ✅ |

---

## Phase 15.1 — Smoke Tests Runtime Contract

### Known Limitation: verify_jwt=true Functions

For Edge Functions with `verify_jwt = true` in `supabase/config.toml`:

- **401 errors are generated by Supabase Edge Gateway** before reaching function code
- These errors do **NOT** pass through `runtime.ts`
- Therefore:
  - ❌ No `correlation_id` in response
  - ❌ No structured `error.code` (AUTH_MISSING_JWT, etc.)
  - ❌ No `runtime_events` logged

**This is expected and correct behavior.**

### Runtime Contract Guarantee

The Phase 14 Runtime Contract is guaranteed **only after successful JWT verification**:

| Function | verify_jwt | Runtime Contract on 401 |
|----------|------------|-------------------------|
| commit-decision | true | ❌ Not applicable |
| generate-case-outputs | true | ❌ Not applicable |
| generate-quotation-pdf | true | ❌ Not applicable |
| generate-quotation | false | ✅ Full contract |
| generate-response | false | ✅ Full contract |

### Rationale

1. `verify_jwt=true` is an **infrastructure-level** security gate
2. Migrating all functions to `verify_jwt=false` would be:
   - A major architectural change
   - A potential security risk
   - Out of scope for Phase 15.1
3. The smoke tests validate **application-level** behavior, not infrastructure rejection

### Test Strategy

Phase 15.1 smoke tests adapt expectations based on function configuration:
- **AUTH tests for verify_jwt=true**: Validate only `status === 401`
- **All other tests**: Validate full runtime contract (correlation_id, error.code, ok flag)

---

## Function Configuration Reference

```toml
# Functions with verify_jwt = true (Gateway-level auth)
[functions.commit-decision]
verify_jwt = true

[functions.generate-case-outputs]
verify_jwt = true

[functions.generate-quotation-pdf]
verify_jwt = true

# Functions with verify_jwt = false (Application-level auth)
[functions.generate-quotation]
verify_jwt = false

[functions.generate-response]
verify_jwt = false
```

---

*Last updated: 2026-02-05 — Phase 15.2 COMPLETED*
