# Phase 15 — Notes & Known Limitations

## Phase 15.3 — Auth Hardening generate-response (✅ COMPLETED)

### Objectif
Sécuriser `generate-response` pour exiger un JWT valide, alignement avec les autres fonctions (pattern auth-in-code).

### Corrections appliquées

| Élément | Description |
|---------|-------------|
| AUTH GUARD | Vérifie `Authorization` header → `AUTH_MISSING_JWT` (401) |
| JWT Validation | `userClient.auth.getUser()` → `AUTH_INVALID_JWT` (401) |
| JSON try/catch | Body non-JSON → `VALIDATION_FAILED` (400) |
| userId propagé | Tous les `logRuntimeEvent` utilisent `userId` authentifié |
| serviceClient tôt | Créé avant auth pour garantir logging forensic |
| console.error minimal | Sans leak de détails auth |

### Tests de validation Phase 15.3

| Test | Body | JWT | HTTP | Error Code | Résultat |
|------|------|-----|------|------------|----------|
| AUTH (sans header) | `{}` | ❌ | 401 | AUTH_MISSING_JWT | ✅ |
| AUTH (token invalide) | `{}` | ❌ invalide | 401 | AUTH_INVALID_JWT | ✅ |
| JSON invalide | `not-json` | ✅ | 400 | VALIDATION_FAILED | ✅ |
| VALIDATION (vide) | `{}` | ✅ | 400 | VALIDATION_FAILED | ✅ |
| VALIDATION (emailId not-uuid) | `{ emailId: "not-a-uuid" }` | ✅ | 400 | VALIDATION_FAILED | ✅ |
| VALIDATION (emailId inexistant) | `{ emailId: "uuid-inexistant" }` | ✅ | 400 | VALIDATION_FAILED | ✅ |
| EXECUTION (nominal) | `{ quotationData: {...} }` | ✅ | 200 | ok: true | ✅ |

### Critères de clôture

| Critère | État |
|---------|------|
| `generate-response` refuse sans JWT | ✅ 401 AUTH_MISSING_JWT |
| Toutes les fonctions alignées (auth en code) | ✅ |
| Runtime contract uniforme sur 5 fonctions | ✅ |
| Aucune erreur `UNKNOWN` | ✅ |

---

## Phase 15.2 — Hardening generate-response (✅ COMPLETED)

## Phase 15.1 — Smoke Tests Runtime Contract

### Known Limitation: verify_jwt=true Functions

For Edge Functions with `verify_jwt = true` in `supabase/config.toml`:

- **401 errors are generated by Supabase Edge Gateway** before reaching function code
- These errors do **NOT** pass through `runtime.ts`
- Therefore:
  - ❌ No `correlation_id` in response
  - ❌ No structured `error.code` (AUTH_MISSING_JWT, etc.)
  - ❌ No `runtime_events` logged

**This is expected and correct behavior.**

### Runtime Contract Guarantee

The Phase 14 Runtime Contract is guaranteed **only after successful JWT verification**:

| Function | verify_jwt | Runtime Contract on 401 |
|----------|------------|-------------------------|
| commit-decision | true | ❌ Not applicable |
| generate-case-outputs | true | ❌ Not applicable |
| generate-quotation-pdf | true | ❌ Not applicable |
| generate-quotation | false | ✅ Full contract |
| generate-response | false | ✅ Full contract |

### Rationale

1. `verify_jwt=true` is an **infrastructure-level** security gate
2. Migrating all functions to `verify_jwt=false` would be:
   - A major architectural change
   - A potential security risk
   - Out of scope for Phase 15.1
3. The smoke tests validate **application-level** behavior, not infrastructure rejection

### Test Strategy

Phase 15.1 smoke tests adapt expectations based on function configuration:
- **AUTH tests for verify_jwt=true**: Validate only `status === 401`
- **All other tests**: Validate full runtime contract (correlation_id, error.code, ok flag)

---

## Function Configuration Reference

```toml
# Functions with verify_jwt = true (Gateway-level auth)
[functions.commit-decision]
verify_jwt = true

[functions.generate-case-outputs]
verify_jwt = true

[functions.generate-quotation-pdf]
verify_jwt = true

# Functions with verify_jwt = false (Application-level auth)
[functions.generate-quotation]
verify_jwt = false

[functions.generate-response]
verify_jwt = false
```

---

*Last updated: 2026-02-05 — Phase 15.2 COMPLETED*
